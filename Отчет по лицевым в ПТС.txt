 declare @rasch_date date
 set @rasch_date = '2019-10-01'
create table #occ (
 occ_id int,
 service int,
 service_group int,
 service_name varchar(255),
 service_group_name varchar(255),
 uk_dog int,
 rasch_date date
)
insert into #occ  -- âõîäÿùåå ñàëüäî
select distinct ns.Ñ÷åò, ns.[Íîìåð óñëóãè], tui.ÐîäèòåëüÍîìåð, tu1.Íàèìåíîâàíèå, tu2.Íàèìåíîâàíèå, ns.ÄîãîâîðÓÊ, @rasch_date  
from stack.ÍÑàëüäî ns inner join stack.[Òèïû óñëóã èåðàðõèÿ] tui on tui.ÏîòîìîêÍîìåð = ns.[Íîìåð óñëóãè] 
inner join stack.[Òèïû óñëóã] tu1 on tu1.[Íîìåð óñëóãè] = ns.[Íîìåð óñëóãè]
inner join stack.[Òèïû óñëóã] tu2 on tu2.[Íîìåð óñëóãè] = tui.ÐîäèòåëüÍîìåð
where CAST([Ìåñÿö ðàñ÷åòà]	as date) = @rasch_date and Ïîñòàâùèê = 1305 and tui.ÐîäèòåëüÒèï=2 and ns.Ñóììà <> 0
 --drop table #occ
union	-- íà÷èñëåíèÿ
select distinct ns.Ñ÷åò, ns.[Íîìåð óñëóãè], tui.ÐîäèòåëüÍîìåð, tu1.Íàèìåíîâàíèå, tu2.Íàèìåíîâàíèå, ns.ÄîãîâîðÓÊ, @rasch_date  
from stack.ÍÒàðèô ns inner join stack.[Òèïû óñëóã èåðàðõèÿ] tui on tui.ÏîòîìîêÍîìåð = ns.[Íîìåð óñëóãè] 
inner join stack.[Òèïû óñëóã] tu1 on tu1.[Íîìåð óñëóãè] = ns.[Íîìåð óñëóãè]
inner join stack.[Òèïû óñëóã] tu2 on tu2.[Íîìåð óñëóãè] = tui.ÐîäèòåëüÍîìåð
where CAST([Ìåñÿö ðàñ÷åòà]	as date) = @rasch_date and Ïîñòàâùèê = 1305 and tui.ÐîäèòåëüÒèï=2 and ns.Ñóììà <> 0

union 		 -- ðàçîâûå
select distinct ns.Ñ÷åò, ns.[Íîìåð óñëóãè], tui.ÐîäèòåëüÍîìåð, tu1.Íàèìåíîâàíèå, tu2.Íàèìåíîâàíèå, ns.ÄîãîâîðÓÊ,  @rasch_date  
from stack.[ÐÍ ñïèñîê] ns inner join stack.[Òèïû óñëóã èåðàðõèÿ] tui on tui.ÏîòîìîêÍîìåð = ns.[Íîìåð óñëóãè] 
inner join stack.[Òèïû óñëóã] tu1 on tu1.[Íîìåð óñëóãè] = ns.[Íîìåð óñëóãè]
inner join stack.[Òèïû óñëóã] tu2 on tu2.[Íîìåð óñëóãè] = tui.ÐîäèòåëüÍîìåð
where CAST([Ìåñÿö ðàñ÷åòà]	as date) = @rasch_date and Ïîñòàâùèê = 1305 and tui.ÐîäèòåëüÒèï=2 and ns.Ñóììà <> 0
 -- select distinct  * from #occ
 -- select * from #occ where occ_id=37368
union 	-- ïëàòåæè
select distinct rsp.Ñ÷åò, rsp.ÍîìåðÓñëóãè, rsp.Óñëóãà, tu1.Íàèìåíîâàíèå, tu2.Íàèìåíîâàíèå, rsp.ÓÊÄîãîâîð, @rasch_date  
from stack.[Ðàñ÷åòû ñ ïîñòàâùèêàìè (äåòàëüíî)] rsp inner join stack.[Òèïû óñëóã] tu1 on tu1.[Íîìåð óñëóãè] = rsp.ÍîìåðÓñëóãè
inner join stack.[Òèïû óñëóã] tu2 on tu2.[Íîìåð óñëóãè] = rsp.Óñëóãà
where CAST(rsp.ÄàòàÎïëàòû as date) BETWEEN @rasch_date and cast(EOMONTH(@rasch_date) as date) and Ïîñòàâùèê = 1305 
and rsp.Ñóììà <> 0 and rsp.ÏðèçíàêÊîððåêöèè <> 1 

--occ_id, ls, rasch_date, serv_id, serv_name, ed, vh_saldo, nach_ob, nach_summ, uk_id

select #occ.occ_id as ËÑ, (select Íîìåð from stack.[Ëèöåâûå ñ÷åòà] where row_id = #occ.occ_id) as Íîìåð_ËÑ, #occ.rasch_date as Ìåñÿö, 
#occ.service as Óñëóãà, #occ.uk_dog, Åä_èçì, ÈñïîëüçîâàíÒàðèô as Òàðèô, isnull(case when nt.Íà÷èñë_ñóììà <> 0 then nt.Íà÷èñë_îáúåì else 0 end,0) as Íà÷èñë_îáúåì,
isnull(nt.Íà÷èñë_ñóììà,0) as Íà÷èñë_ñóììà, isnull(rn.Ñóììà_ðàçîâûõ,0) as Ðàçîâûå, isnull(rn.Ïðèìå÷àíèå,'') as Ðàçîâûå_ïðèì, isnull(opl.Ñóììà,0) as Ñóììà_ïëàòåæåé,
isnull(ns.Ñóììà,0) as ÂÕ_Ñàëüäî, (isnull(ns.Ñóììà,0) + isnull(nt.Íà÷èñë_ñóììà,0) + isnull(rn.Ñóììà_ðàçîâûõ,0)) as ÈÑÕ_Ñàëüäî, 
-- ïîñëåäíÿÿ îïëàòà
(select MAX(lopl.Äàòà) from (
  select MAX(so.Äàòà) as Äàòà 
  from stack.[Ñïèñîê îïëàòû] so inner join stack.[Îïëàòà ïî âèäàì] opv on so.ROW_ID = opv.[Ðàñïðåäåëåíèå-Ïëàòåæ]
  inner join stack.[Òèïû óñëóã] tu on tu.ROW_ID = opv.[Ðàñïðåäåëåíèå-Óñëóãà] 
  inner join stack.Îðãàíèçàöèè org on opv.[Ðàñïðåäåëåíèå-ÓÊ] = org.ROW_ID
  inner join stack.[ÓÊ äîãîâîðû] ukd on ukd.[Îðãàíèçàöèÿ-ÓÊÄîãîâîð] = org.ROW_ID
  where ukd.ROW_ID = #occ.uk_dog and so.[Ñ÷åò-Îïëàòà] = #occ.occ_id and tu.[Íîìåð óñëóãè] = #occ.service
  union
  select MAX(ÄàòàÎïëàòû) as Äàòà from stack.[Ðàñ÷åòû ñ ïîñòàâùèêàìè (äåòàëüíî)]
  where ÓÊÄîãîâîð= #occ.uk_dog and Ñ÷åò= #occ.occ_id and ÍîìåðÓñëóãè= #occ.service) as lopl
  ) as Ïîñë_îïë, 
-- ñ÷åò÷èêè
isnull ((select sc.Ïîêàçàíèå from 
	(SELECT ps.Ïîêàçàíèå, ROW_NUMBER() over(order by so.[N ï/ï]) as sch_num, cast (Äàòà as date) as Äàòà, cast(Max(Äàòà) OVER() as date)  as MaxDate 
	from stack.[Ïîêàçàíèÿ ñ÷åò÷èêîâ] ps inner join stack.[Ñïèñîê îáúåêòîâ] so on so.ROW_ID = ps.[Îáúåêò-Ïîêàçàíèÿ]
	inner join stack.[Òèïû óñëóã] tu on tu.ROW_ID =ps.[Ïîêàçàíèÿ-Óñëóãà]
	where tu.[Íîìåð óñëóãè] = #occ.service_group
	and ps.[Ïîêàçàíèÿ-Ñ÷åò]=#occ.occ_id	and cast(ps.[Ðàñ÷åòíûé ìåñÿö] as date) = #occ.rasch_date)
	as sc where sc.sch_num=1 and Äàòà = MaxDate),null) as SCH_1,
isnull ((select sc.Ïîêàçàíèå from 
	(SELECT ps.Ïîêàçàíèå, ROW_NUMBER() over(order by so.[N ï/ï]) as sch_num, cast (Äàòà as date) as Äàòà, cast(Max(Äàòà) OVER() as date)  as MaxDate 
	from stack.[Ïîêàçàíèÿ ñ÷åò÷èêîâ] ps inner join stack.[Ñïèñîê îáúåêòîâ] so on so.ROW_ID = ps.[Îáúåêò-Ïîêàçàíèÿ]
	inner join stack.[Òèïû óñëóã] tu on tu.ROW_ID =ps.[Ïîêàçàíèÿ-Óñëóãà]
	where tu.[Íîìåð óñëóãè] = #occ.service_group
	and ps.[Ïîêàçàíèÿ-Ñ÷åò]=#occ.occ_id	and cast(ps.[Ðàñ÷åòíûé ìåñÿö] as date) = #occ.rasch_date)
	as sc where sc.sch_num=2 and Äàòà = MaxDate),null) as SCH_2,
isnull ((select sc.Ïîêàçàíèå from 
	(SELECT ps.Ïîêàçàíèå, ROW_NUMBER() over(order by so.[N ï/ï]) as sch_num, cast (Äàòà as date) as Äàòà, cast(Max(Äàòà) OVER() as date)  as MaxDate 
	from stack.[Ïîêàçàíèÿ ñ÷åò÷èêîâ] ps inner join stack.[Ñïèñîê îáúåêòîâ] so on so.ROW_ID = ps.[Îáúåêò-Ïîêàçàíèÿ]
	inner join stack.[Òèïû óñëóã] tu on tu.ROW_ID =ps.[Ïîêàçàíèÿ-Óñëóãà]
	where tu.[Íîìåð óñëóãè] = #occ.service_group
	and ps.[Ïîêàçàíèÿ-Ñ÷åò]=#occ.occ_id	and cast(ps.[Ðàñ÷åòíûé ìåñÿö] as date) = #occ.rasch_date)
	as sc where sc.sch_num=3 and Äàòà = MaxDate),null) as SCH_3,
isnull ((select sc.Ïîêàçàíèå from 
	(SELECT ps.Ïîêàçàíèå, ROW_NUMBER() over(order by so.[N ï/ï]) as sch_num, cast (Äàòà as date) as Äàòà, cast(Max(Äàòà) OVER() as date)  as MaxDate 
	from stack.[Ïîêàçàíèÿ ñ÷åò÷èêîâ] ps inner join stack.[Ñïèñîê îáúåêòîâ] so on so.ROW_ID = ps.[Îáúåêò-Ïîêàçàíèÿ]
	inner join stack.[Òèïû óñëóã] tu on tu.ROW_ID =ps.[Ïîêàçàíèÿ-Óñëóãà]
	where tu.[Íîìåð óñëóãè] = #occ.service_group
	and ps.[Ïîêàçàíèÿ-Ñ÷åò]=#occ.occ_id	and cast(ps.[Ðàñ÷åòíûé ìåñÿö] as date) = #occ.rasch_date)
	as sc where sc.sch_num=4 and Äàòà = MaxDate),null) as SCH_4,
isnull ((select sc.Ïîêàçàíèå from 
	(SELECT ps.Ïîêàçàíèå, ROW_NUMBER() over(order by so.[N ï/ï]) as sch_num, cast (Äàòà as date) as Äàòà, cast(Max(Äàòà) OVER() as date)  as MaxDate 
	from stack.[Ïîêàçàíèÿ ñ÷åò÷èêîâ] ps inner join stack.[Ñïèñîê îáúåêòîâ] so on so.ROW_ID = ps.[Îáúåêò-Ïîêàçàíèÿ]
	inner join stack.[Òèïû óñëóã] tu on tu.ROW_ID =ps.[Ïîêàçàíèÿ-Óñëóãà]
	where tu.[Íîìåð óñëóãè] = #occ.service_group
	and ps.[Ïîêàçàíèÿ-Ñ÷åò]=#occ.occ_id	and cast(ps.[Ðàñ÷åòíûé ìåñÿö] as date) = #occ.rasch_date)
	as sc where sc.sch_num=5 and Äàòà = MaxDate),null) as SCH_5
from #occ 
-- âõîäÿùåå ñàëüäî
left join (select sum(Ñóììà) as ñóììà, [Íîìåð óñëóãè], ÄîãîâîðÓÊ, Ñ÷åò from stack.ÍÑàëüäî where cast([Ìåñÿö ðàñ÷åòà] as date)=@rasch_date   group by [Íîìåð óñëóãè], ÄîãîâîðÓÊ, Ñ÷åò)
as ns on ns.ÄîãîâîðÓÊ=#occ.uk_dog and ns.[Íîìåð óñëóãè] = #occ.service and #occ.occ_id = ns.Ñ÷åò 
-- íà÷èñëåíèÿ
left join (select sum(Ñóììà) as Íà÷èñë_ñóììà, sum(Îáúåì) as Íà÷èñë_îáúåì, [Íîìåð óñëóãè], ÄîãîâîðÓÊ, Ñ÷åò, ÈñïîëüçîâàíÒàðèô, (select top 1 [Åäèíèöà èçìåðåíèÿ] from stack.[Òèïû óñëóã] tu where tu.[Íîìåð óñëóãè] = nl.[Íîìåð óñëóãè]) as Åä_èçì 
from stack.[Íà÷èñëåíèÿ ëèöåâûõ] nl where cast([Ìåñÿö ðàñ÷åòà] as date)=@rasch_date   group by [Íîìåð óñëóãè], ÄîãîâîðÓÊ, Ñ÷åò, ÈñïîëüçîâàíÒàðèô)
as nt on nt.ÄîãîâîðÓÊ=#occ.uk_dog and nt.[Íîìåð óñëóãè] = #occ.service and #occ.occ_id = nt.Ñ÷åò
-- ðàçîâûå
left join (select sum(rns.Ñóììà) as Ñóììà_ðàçîâûõ, rns.[Íîìåð óñëóãè], rns.ÄîãîâîðÓÊ, rns.Ñ÷åò, rnd.Ïðèìå÷àíèå 
from stack.[ÐÍ ñïèñîê] rns inner join stack.[ÐÍ äîêóìåíò] rnd on rns.[ÐÍ-Ñïèñîê] = rnd.ROW_ID where cast(rns.[Ìåñÿö ðàñ÷åòà] as date)=@rasch_date
group by  rns.[Íîìåð óñëóãè], rns.ÄîãîâîðÓÊ, rns.Ñ÷åò, rnd.Ïðèìå÷àíèå) as rn
on rn.[Íîìåð óñëóãè]=#occ.service and rn.Ñ÷åò = #occ.occ_id and rn.ÄîãîâîðÓÊ=#occ.uk_dog 
-- ïëàòåæè
left join (select sum(Ñóììà) as Ñóììà, ÍîìåðÓñëóãè, ÓÊÄîãîâîð, Ñ÷åò from stack.[Ðàñ÷åòû ñ ïîñòàâùèêàìè (äåòàëüíî)]
where CAST(ÄàòàÎïëàòû as date) BETWEEN @rasch_date and cast(EOMONTH(@rasch_date) as date) group by ÍîìåðÓñëóãè, ÓÊÄîãîâîð, Ñ÷åò) as opl on
opl.ÍîìåðÓñëóãè = #occ.service and opl.Ñ÷åò = #occ.occ_id and opl.ÓÊÄîãîâîð=#occ.uk_dog
left join (select distinct ÓÊÄîãîâîð, Ñ÷åò, ÍîìåðÓñëóãè, MAX(ÄàòàÎïëàòû) OVER(partition by Ñ÷åò, ÓÊÄîãîâîð, ÍîìåðÓñëóãè) as lp_date  from stack.[Ðàñ÷åòû ñ ïîñòàâùèêàìè (äåòàëüíî)]) lp
on lp.ÍîìåðÓñëóãè=#occ.service and lp.Ñ÷åò=#occ.occ_id and lp.ÓÊÄîãîâîð=#occ.uk_dog
-- ïëîùàäü ëèöåâûõ






 
where #occ.occ_id=62368

 

drop table #occ
